name: Ubuntu Desktop + NoMachine + Tailscale

on:
  workflow_dispatch:

jobs:
  desktop:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Update & install Docker
        run: |
          sudo apt-get update -y
          sudo apt-get remove -y containerd containerd.io || true
          sudo apt-get install -y ca-certificates curl gnupg lsb-release software-properties-common
          curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /usr/share/keyrings/docker.gpg
          echo "deb [arch=amd64 signed-by=/usr/share/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable" \
            | sudo tee /etc/apt/sources.list.d/docker.list
          sudo apt-get update -y
          sudo apt-get install -y docker-ce docker-ce-cli containerd.io docker-compose-plugin

      - name: Pull Ubuntu desktop base
        run: |
          docker pull ubuntu:22.04

      - name: Run container with systemd support
        run: |
          docker rm -f ubuntu_gui || true
          docker run -d --name ubuntu_gui --privileged \
            -v /sys/fs/cgroup:/sys/fs/cgroup:ro \
            -p 4000:4000 \
            ubuntu:22.04 sleep infinity

      - name: Install Ubuntu Desktop + NoMachine inside container
        run: |
          docker exec ubuntu_gui bash -c "apt-get update"
          docker exec ubuntu_gui bash -c "DEBIAN_FRONTEND=noninteractive apt-get install -y ubuntu-desktop"
          docker exec ubuntu_gui bash -c "wget https://downloads.nomachine.com/download/8.12/Linux/nomachine_8.12.1_1_amd64.deb"
          docker exec ubuntu_gui bash -c "apt install -y ./nomachine_*.deb"

      - name: Install Tailscale on host
        env:
          TS_AUTH_KEY: ${{ secrets.TS_AUTH_KEY }}
        run: |
          curl -fsSL https://tailscale.com/install.sh | sh
          sudo tailscale up --authkey="${TS_AUTH_KEY}" --hostname=GitHub-NoMachine --accept-routes --accept-dns=false
          tailscale ip -4

      - name: Print connection info
        run: |
          TS_IP=$(tailscale ip -4)
          echo "============================"
          echo "ðŸŽ‰ NoMachine Ø¬Ø§Ù‡Ø²!"
          echo "Ø§ØªØµÙ„ Ù…Ù† Ø¬Ù‡Ø§Ø²Ùƒ:"
          echo "nx://$TS_IP"
          echo ""
          echo "Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: root"
          echo "ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±: (Ù‚Ù… Ø¨ØªØ¹ÙŠÙŠÙ†Ù‡Ø§ Ø¯Ø§Ø®Ù„ Ø§Ù„Ø¬Ù„Ø³Ø©)"
          echo "============================"

      - name: Keep session alive
        run: |
          while true; do sleep 300; done
