name: Kali-RDP-NoMachine-Tailscale

on:
  workflow_dispatch:

jobs:
  kali:
    runs-on: ubuntu-latest
    timeout-minutes: 3600

    steps:

    # -----------------------------------------------------
    # احتياطي: اظهار بيئة runner (اختياري للتشخيص)
    # -----------------------------------------------------
    - name: Runner info
      run: |
        uname -a
        lsb_release -a || true

    # -----------------------------------------------------
    # 1) تثبيت Docker
    # -----------------------------------------------------
    - name: Install Docker
      run: |
        if ! command -v docker >/dev/null 2>&1; then
          curl -fsSL https://get.docker.com | sh
          sudo systemctl enable --now docker
        else
          docker --version
        fi

    # -----------------------------------------------------
    # 2) قتل أي عملية Tailscale قديمة
    # -----------------------------------------------------
    - name: Kill old Tailscale
      run: |
        sudo pkill tailscaled || true
        sudo pkill tailscale || true

    # -----------------------------------------------------
    # 3) تثبيت Tailscale على الـ runner
    # -----------------------------------------------------
    - name: Install Tailscale
      run: |
        sudo apt-get update -y
        sudo apt-get install -y curl gnupg
        curl -fsSL https://tailscale.com/install.sh | sudo sh

    # -----------------------------------------------------
    # 4) تشغيل tailscaled + تسجيل الدخول (انتظر حتى يصبح جاهزاً)
    # -----------------------------------------------------
    - name: Start tailscaled and tailscale up
      env:
        TAILSCALE_AUTH_KEY: ${{ secrets.TAILSCALE_AUTH_KEY }}
      run: |
        # start tailscaled in background
        sudo tailscaled --state=/tmp/tailscaled.state --socket=/tmp/tailscaled.sock >/tmp/tailscaled.log 2>&1 &
        # انتظر حتى يظهر socket و يصبح tailscale جاهزاً
        for i in $(seq 1 20); do
          if sudo tailscale status >/dev/null 2>&1; then
            break
          fi
          sleep 1
        done
        # رفع الجهاز إلى الشبكة
        sudo tailscale up --authkey="${TAILSCALE_AUTH_KEY}" --hostname="kali-${GITHUB_RUN_ID}" || (sleep 2 && sudo tailscale up --authkey="${TAILSCALE_AUTH_KEY}" --hostname="kali-${GITHUB_RUN_ID}") || true
        # احصل على IPv4 الخاص بـ Tailscale
        TAILSCALE_IP="$(sudo tailscale ip -4 || true)"
        echo "TAILSCALE_IP=${TAILSCALE_IP}" >> $GITHUB_ENV
        echo "tailscale status:"
        sudo tailscale status || true

    # -----------------------------------------------------
    # 5) سحب صورة Kali
    # -----------------------------------------------------
    - name: Pull Kali Docker Image
      run: sudo docker pull kalilinux/kali-rolling

    # -----------------------------------------------------
    # 6) حذف الكونتينر القديم إن وُجد
    # -----------------------------------------------------
    - name: Remove Old Container
      run: |
        sudo docker rm -f kali || true

    # -----------------------------------------------------
    # 7) إنشاء الكونتينر الخاص بـ Kali
    # -----------------------------------------------------
    - name: Create Kali Container
      run: |
        sudo docker run -d --name kali \
          --hostname kali-nx \
          --privileged \
          --cap-add=NET_ADMIN \
          -p 3389:3389 \
          -p 4000:4000 \
          kalilinux/kali-rolling sleep infinity

    # -----------------------------------------------------
    # 8) إنشاء مستخدم جديد داخل الكونتينر (بأمان)
    # -----------------------------------------------------
    - name: Create kaliuser inside container
      run: |
        PASS=$(tr -dc 'A-Za-z0-9' </dev/urandom | head -c 12)
        # نمرر كلمة المرور كمتغير بيئة داخل docker exec
        sudo docker exec -i kali bash -lc "useradd -m -s /bin/bash kaliuser || true; echo \"kaliuser:${PASS}\" | chpasswd; usermod -aG sudo kaliuser || true; mkdir -p /home/kaliuser; chown -R kaliuser:kaliuser /home/kaliuser || true"
        echo "RDP_USER=kaliuser" >> $GITHUB_ENV
        echo "RDP_PASS=${PASS}" >> $GITHUB_ENV

    # -----------------------------------------------------
    # 9) تثبيت واجهة سطح مكتب و XRDP و NoMachine و الأدوات المطلوبة داخل الكونتينر
    # -----------------------------------------------------
    - name: Install GUI + XRDP + NoMachine
      run: |
        sudo docker exec kali bash -lc "
          set -e
          export DEBIAN_FRONTEND=noninteractive
          apt-get update -y
          # تثبيت الحزم الأساسية (تضمّن iptables و nftables و net-tools)
          apt-get install -y --no-install-recommends \
            xfce4 xfce4-goodies xorgxrdp xrdp dbus-x11 xserver-xorg-core \
            wget curl nano sudo inetutils-ping net-tools iptables nftables ca-certificates gnupg || true

          # اضبط الجلسة الافتراضية للمستخدم root و kaliuser
          echo 'xfce4-session' > /root/.xsession || true
          mkdir -p /home/kaliuser
          echo 'xfce4-session' > /home/kaliuser/.xsession || true
          chown kaliuser:kaliuser /home/kaliuser/.xsession || true

          # تثبيت NoMachine (إذا تغيّرت النسخة يمكنك تعديل الرابط)
          NOMACHINE_DEB=/tmp/nomachine.deb
          wget -q https://download.nomachine.com/download/8.12/Linux/nomachine_8.12.3_1_amd64.deb -O ${NOMACHINE_DEB} || true
          if [ -f \"${NOMACHINE_DEB}\" ]; then
            dpkg -i ${NOMACHINE_DEB} || apt-get -y -f install
          fi
        "

    # -----------------------------------------------------
    # 10) تشغيل خدمات داخل الكونتينر (dbus, xrdp, nomachine)
    # -----------------------------------------------------
    - name: Start Services
      run: |
        sudo docker exec -d kali bash -lc "rm -f /var/run/dbus/pid || true; /usr/bin/dbus-daemon --system --fork || true"
        sudo docker exec -d kali bash -lc "mkdir -p /var/run/xrdp || true; /usr/sbin/xrdp-sesman || true"
        sudo docker exec -d kali bash -lc "/usr/sbin/xrdp || true"
        # حاول تشغيل NoMachine server إن وُجد
        sudo docker exec -d kali bash -lc "if [ -x /usr/NX/bin/nxserver ]; then /usr/NX/bin/nxserver --startup || true; fi"
        sleep 4
        sudo docker exec kali ss -tulpen | grep -E '3389|4000' || true

    # -----------------------------------------------------
    # 11) تعطيل الجدار الناري داخل الكونتينر (إن لزم)
    # -----------------------------------------------------
    - name: Disable Firewall inside container
      run: |
        sudo docker exec kali bash -lc "
          apt-get install -y iptables nftables || true
          nft flush ruleset || true
          iptables -F || true
        "

    # -----------------------------------------------------
    # 12) طباعة بيانات الوصول وتشخيص الشبكة
    # -----------------------------------------------------
    - name: Show Access Info & Diagnostics
      run: |
        echo ""
        echo "===================================="
        echo "       Kali Remote Access"
        echo "===================================="
        echo "Tailscale IP : ${TAILSCALE_IP:-<not-found>}"
        echo ""
        echo "RDP          : ${TAILSCALE_IP:-<not-found>}:3389"
        echo "NoMachine    : ${TAILSCALE_IP:-<not-found>}:4000"
        echo ""
        echo "User         : $RDP_USER"
        echo "Password     : $RDP_PASS"
        echo "===================================="
        echo ""
        echo '--- container listening ports ---'
        sudo docker exec kali ss -tulpen || true
        echo '--- iptables (container) ---'
        sudo docker exec kali iptables -L -n -v || true
        echo '--- nft rules (container) ---'
        sudo docker exec kali nft list ruleset || true

    # -----------------------------------------------------
    # 13) Debug logs
    # -----------------------------------------------------
    - name: Debug Logs
      run: |
        echo '---- xrdp logs ----'
        sudo docker exec kali bash -c "tail -n 200 /var/log/xrdp.log || true"
        sudo docker exec kali bash -c "tail -n 200 /var/log/xrdp-sesman.log || true"
        echo '---- NoMachine logs (if any) ----'
        sudo docker exec kali bash -c "ls -la /usr/NX/var/log || true; tail -n 200 /usr/NX/var/log/* 2>/dev/null || true"

    # -----------------------------------------------------
    # 14) (اختياري) إبقاء الجلسة حية — يمكنك إزالة هذا إذا لا تريد أن يبقى الـ runner مشغولًا
    # -----------------------------------------------------
    - name: Keep Alive (optional)
      run: |
        # ملاحظة: هذا سيُبقي الـ runner مشغولاً حتى انتهاء timeout-minutes.
        # يمكنك تغييره إلى 'sleep 300' أو حذفه.
        while true; do sleep 300; done
