name: Kali-RDP-NoMachine-Tailscale
on:
  workflow_dispatch:

jobs:
  kali:
    runs-on: ubuntu-latest
    timeout-minutes: 3600

    steps:
    - name: Install Docker
      run: |
        docker --version || (curl -fsSL https://get.docker.com | sh && sudo systemctl start docker)

    - name: Install Tailscale (host)
      run: |
        sudo apt-get update
        sudo apt-get install -y curl gnupg
        curl -fsSL https://tailscale.com/install.sh | sudo sh

    - name: Start tailscaled + Login
      env:
        TAILSCALE_AUTH_KEY: ${{ secrets.TAILSCALE_AUTH_KEY }}
      run: |
        sudo tailscaled --state=/tmp/tailscaled.state --socket=/tmp/tailscaled.sock &
        sleep 3
        sudo tailscale up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} --hostname=kali-nx-${GITHUB_RUN_ID}
        echo "TAILSCALE_IP=$(sudo tailscale ip -4)" >> $GITHUB_ENV

    - name: Pull Kali Docker Image
      run: sudo docker pull kalilinux/kali-rolling

    - name: Remove Old Container
      run: sudo docker rm -f kali || true

    - name: Start Kali Container
      run: |
        sudo docker run -d --name kali \
          --hostname kali-nx \
          --privileged \
          -p 3389:3389 \
          -p 4000:4000 \
          kalilinux/kali-rolling sleep infinity

    - name: Create User
      run: |
        PASS=$(tr -dc 'A-Za-z0-9' </dev/urandom | head -c 12)
        sudo docker exec kali bash -c "
          useradd -m -s /bin/bash kaliuser || true &&
          echo 'kaliuser:${PASS}' | chpasswd &&
          usermod -aG sudo kaliuser
        "
        echo "RDP_USER=kaliuser" >> $GITHUB_ENV
        echo "RDP_PASS=$PASS" >> $GITHUB_ENV

    - name: Install GUI + XRDP + NoMachine
      run: |
        sudo docker exec kali bash -c "
          apt-get update &&
          DEBIAN_FRONTEND=noninteractive apt-get install -y \
            xfce4 xfce4-goodies xorg xserver-xorg-core xserver-xorg-video-all xfonts-base \
            xrdp dbus-x11 inetutils-ping net-tools iptables nftables curl wget nano sudo

          # xfce session
          echo 'startxfce4' > /root/.xsession
          echo 'startxfce4' > /home/kaliuser/.xsession
          chown kaliuser:kaliuser /home/kaliuser/.xsession

          # install NoMachine
          wget -q https://download.nomachine.com/download/8.12/Linux/nomachine_8.12.3_1_amd64.deb -O /tmp/nomachine.deb
          dpkg -i /tmp/nomachine.deb || apt-get -f install -y
        "

    - name: Start Services (without systemd)
      run: |
        sudo docker exec -d kali bash -c "dbus-daemon --system --fork"
        sudo docker exec -d kali bash -c "/usr/sbin/xrdp-sesman"
        sudo docker exec -d kali bash -c "/usr/sbin/xrdp"
        sudo docker exec -d kali bash -c "/usr/NX/bin/nxserver --startup"

    - name: Disable Firewall
      run: |
        sudo docker exec kali bash -c "
          iptables -P INPUT ACCEPT
          iptables -P OUTPUT ACCEPT
          iptables -P FORWARD ACCEPT
          iptables -F || true
          nft flush ruleset || true
        "

    - name: Show Access Info
      run: |
        echo " "
        echo "===================================="
        echo "      Kali RDP / NoMachine Access"
        echo "===================================="
        echo "Tailscale IP : $TAILSCALE_IP"
        echo "User         : $RDP_USER"
        echo "Password     : $RDP_PASS"
        echo "RDP          : $TAILSCALE_IP:3389"
        echo "NoMachine    : $TAILSCALE_IP:4000"
        echo "===================================="
        echo " "

    - name: Keep Alive
      run: while true; do sleep 300; done
