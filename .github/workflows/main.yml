name: Linux-SSH
on:
  workflow_dispatch:

jobs:
  ssh-access:
    runs-on: ubuntu-latest
    timeout-minutes: 3600

    steps:
    - name: Update & Install SSH
      run: |
        sudo apt-get update
        sudo apt-get install -y openssh-server
        sudo systemctl enable ssh
        sudo systemctl start ssh

        # السماح بمنفذ SSH
        sudo ufw allow 22/tcp || true

    - name: Create SSH User
      run: |
        # توليد كلمة مرور قوية
        PASS=$(tr -dc A-Za-z0-9\!\@\#\$\%\^\&\*\(\) </dev/urandom | head -c 18)
        sudo useradd -m -s /bin/bash linuxuser
        echo "linuxuser:$PASS" | sudo chpasswd

        echo "SSH_USER=linuxuser" >> $GITHUB_ENV
        echo "SSH_PASS=$PASS" >> $GITHUB_ENV

    - name: Install Tailscale
      run: |
        curl -fsSL https://pkgs.tailscale.com/stable/ubuntu/jammy.gpg | sudo tee /usr/share/keyrings/tailscale-archive-keyring.gpg >/dev/null
        curl -fsSL https://pkgs.tailscale.com/stable/ubuntu/jammy.list | sudo tee /etc/apt/sources.list.d/tailscale.list
        sudo apt-get update
        sudo apt-get install -y tailscale

    - name: Connect Tailscale
      run: |
        sudo tailscale up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} --hostname=linux-runner-$GITHUB_RUN_ID
        sleep 5
        TSIP=$(tailscale ip -4)
        echo "TS_IP=$TSIP" >> $GITHUB_ENV

    - name: Show Connection Info
      run: |
        echo ""
        echo "===================================="
        echo " SSH ACCESS INFO "
        echo "------------------------------------"
        echo "IP:       $TS_IP"
        echo "User:     $SSH_USER"
        echo "Password: $SSH_PASS"
        echo "===================================="
        echo ""

    - name: Keep alive
      run: |
        while true; do
          echo "[$(date)] SSH Active..."
          sleep 300
        done
