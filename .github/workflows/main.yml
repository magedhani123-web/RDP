name: Kali-RDP-NoMachine-Tailscale

on:
  workflow_dispatch:

jobs:
  kali:
    runs-on: ubuntu-latest
    timeout-minutes: 3600

    steps:

    # -----------------------------------------------------
    # 0) Runner info
    # -----------------------------------------------------
    - name: Runner info
      run: |
        uname -a
        lsb_release -a || true

    # -----------------------------------------------------
    # 1) Install Docker
    # -----------------------------------------------------
    - name: Install Docker
      run: |
        if ! command -v docker >/dev/null 2>&1; then
          curl -fsSL https://get.docker.com | sh
          sudo systemctl enable --now docker
        else
          docker --version
        fi

    # -----------------------------------------------------
    # 2) Kill old tailscale
    # -----------------------------------------------------
    - name: Kill old Tailscale
      run: |
        sudo pkill tailscaled || true
        sudo pkill tailscale || true

    # -----------------------------------------------------
    # 3) Install Tailscale
    # -----------------------------------------------------
    - name: Install Tailscale
      run: |
        sudo apt-get update -y
        sudo apt-get install -y curl gnupg
        curl -fsSL https://tailscale.com/install.sh | sudo sh

    # -----------------------------------------------------
    # 4) Start tailscaled + login
    # -----------------------------------------------------
    - name: Start Tailscale
      env:
        TAILSCALE_AUTH_KEY: ${{ secrets.TAILSCALE_AUTH_KEY }}
      run: |
        sudo tailscaled --state=/tmp/tailscaled.state --socket=/tmp/tailscaled.sock >/tmp/tailscaled.log 2>&1 &
        sleep 3
        sudo tailscale up --authkey="${TAILSCALE_AUTH_KEY}" --hostname="kali-${GITHUB_RUN_ID}" --accept-routes --ssh || true
        TAILSCALE_IP="$(sudo tailscale ip -4 || true)"
        echo "TAILSCALE_IP=$TAILSCALE_IP" >> $GITHUB_ENV
        sudo tailscale status || true

    # -----------------------------------------------------
    # 5) Pull Kali image
    # -----------------------------------------------------
    - name: Pull Kali Docker Image
      run: sudo docker pull kalilinux/kali-rolling

    # -----------------------------------------------------
    # 6) Remove old container
    # -----------------------------------------------------
    - name: Remove Old Container
      run: sudo docker rm -f kali || true

    # -----------------------------------------------------
    # 7) Create Kali container
    # -----------------------------------------------------
    - name: Create Kali Container
      run: |
        sudo docker run -d --name kali \
          --hostname kali-nx \
          --privileged \
          --cap-add=NET_ADMIN \
          -p 3389:3389 \
          -p 4000:4000 \
          kalilinux/kali-rolling sleep infinity

    # -----------------------------------------------------
    # 8) Create user
    # -----------------------------------------------------
    - name: Create kaliuser inside container
      run: |
        PASS=$(tr -dc 'A-Za-z0-9' </dev/urandom | head -c 12)
        sudo docker exec -i kali bash -lc "
          useradd -m -s /bin/bash kaliuser || true
          echo \"kaliuser:${PASS}\" | chpasswd
          usermod -aG sudo kaliuser || true
        "
        echo "RDP_USER=kaliuser" >> $GITHUB_ENV
        echo "RDP_PASS=${PASS}" >> $GITHUB_ENV

    # -----------------------------------------------------
    # 9) Install GUI + XRDP + NoMachine
    # -----------------------------------------------------
    - name: Install GUI + XRDP + NoMachine
      run: |
        sudo docker exec kali bash -lc "
          set -e
          export DEBIAN_FRONTEND=noninteractive
          apt-get update -y
          apt-get install -y --no-install-recommends \
            xfce4 xfce4-goodies xorgxrdp xrdp dbus-x11 xserver-xorg-core \
            wget curl nano sudo inetutils-ping net-tools iptables nftables
          echo 'xfce4-session' > /root/.xsession
          echo 'xfce4-session' > /home/kaliuser/.xsession
          chown kaliuser:kaliuser /home/kaliuser/.xsession
          wget -q https://download.nomachine.com/download/8.12/Linux/nomachine_8.12.3_1_amd64.deb -O /tmp/nx.deb
          dpkg -i /tmp/nx.deb || apt -f install -y
        "

    # -----------------------------------------------------
    # 10) Start services
    # -----------------------------------------------------
    - name: Start Services
      run: |
        sudo docker exec -d kali bash -lc "rm -f /var/run/dbus/pid; dbus-daemon --system --fork"
        sudo docker exec -d kali bash -lc "mkdir -p /var/run/xrdp; xrdp-sesman"
        sudo docker exec -d kali bash -lc "xrdp"
        sudo docker exec -d kali bash -lc "/usr/NX/bin/nxserver --startup || true"
        sleep 4
        sudo docker exec kali ss -tulpen | grep -E '3389|4000' || true

    # -----------------------------------------------------
    # 11) Disable firewall
    # -----------------------------------------------------
    - name: Disable Firewall inside container
      run: |
        sudo docker exec kali bash -lc "
          iptables -F || true
          nft flush ruleset || true
        "

    # -----------------------------------------------------
    # 12) Show Access Info
    # -----------------------------------------------------
    - name: Show Access Info & Diagnostics
      run: |
        echo ""
        echo "===================================="
        echo "       Kali Remote Access"
        echo "===================================="
        echo "Tailscale IP : ${TAILSCALE_IP}"
        echo ""
        echo "RDP          : ${TAILSCALE_IP}:3389"
        echo "NoMachine    : ${TAILSCALE_IP}:4000"
        echo ""
        echo "User         : $RDP_USER"
        echo "Password     : $RDP_PASS"
        echo "===================================="

    # -----------------------------------------------------
    # 13) Job Summary
    # -----------------------------------------------------
    - name: Write Access Info to Job Summary
      run: |
        {
          echo "## Kali Remote Access"
          echo ""
          echo "- **Tailscale IP:** ${TAILSCALE_IP}"
          echo "- **RDP:** ${TAILSCALE_IP}:3389"
          echo "- **NoMachine:** ${TAILSCALE_IP}:4000"
          echo "- **User:** ${RDP_USER}"
          echo "- **Password:** ${RDP_PASS}"
        } >> $GITHUB_STEP_SUMMARY

    # -----------------------------------------------------
    # 14) Keep Alive
    # -----------------------------------------------------
    - name: Keep Alive
      run: |
        while true; do sleep 300; done
