name: Kali-SSH
on:
  workflow_dispatch:

jobs:
  kali:
    runs-on: ubuntu-latest
    timeout-minutes: 3600

    steps:

    - name: Check Docker
      run: docker --version

    - name: Pull Kali Linux Image
      run: |
        sudo docker pull kalilinux/kali-rolling

    - name: Start Kali Container
      run: |
        sudo docker run -d --name kali \
          --hostname kali-runner \
          --cap-add NET_ADMIN \
          -p 22:22 \
          kalilinux/kali-rolling sleep infinity

    - name: Install SSH inside Kali
      run: |
        sudo docker exec kali bash -c "
          apt-get update &&
          apt-get install -y openssh-server &&
          mkdir -p /var/run/sshd &&
          sed -i 's/#PasswordAuthentication yes/PasswordAuthentication yes/' /etc/ssh/sshd_config &&
          sed -i 's/#PermitRootLogin prohibit-password/PermitRootLogin yes/' /etc/ssh/sshd_config
        "

    - name: Create User in Kali
      run: |
        PASS=$(tr -dc A-Za-z0-9 </dev/urandom | head -c 16)
        sudo docker exec kali bash -c "
          useradd -m -s /bin/bash kaliuser &&
          echo 'kaliuser:$PASS' | chpasswd
        "
        echo "SSH_USER=kaliuser" >> $GITHUB_ENV
        echo "SSH_PASS=$PASS" >> $GITHUB_ENV

    - name: Install Tailscale inside Kali
      run: |
        sudo docker exec kali bash -c "
          apt-get update &&
          apt-get install -y curl &&
          curl -fsSL https://pkgs.tailscale.com/stable/debian/bookworm.gpg | tee /usr/share/keyrings/tailscale.gpg >/dev/null &&
          curl -fsSL https://pkgs.tailscale.com/stable/debian/bookworm.list | tee /etc/apt/sources.list.d/tailscale.list &&
          apt-get update &&
          apt-get install -y tailscale
        "

    - name: Connect Tailscale
      run: |
        sudo docker exec kali bash -c "
          tailscale up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} --hostname=kali-${GITHUB_RUN_ID}
        "
        TSIP=$(sudo docker exec kali tailscale ip -4)
        echo "TS_IP=$TSIP" >> $GITHUB_ENV

    - name: Install Kali Tools
      run: |
        sudo docker exec kali bash -c "
          apt-get update &&
          apt-get install -y \
            nmap hydra metasploit-framework sqlmap \
            wireshark-qt john nikto gobuster \
            netcat-traditional
        "

    - name: Start SSH Daemon
      run: |
        sudo docker exec -d kali bash -c "/usr/sbin/sshd -D"

    - name: Show SSH Info
      run: |
        echo ""
        echo "==================== Kali SSH ===================="
        echo "Tailscale IP: $TS_IP"
        echo "User:         $SSH_USER"
        echo "Password:     $SSH_PASS"
        echo "=================================================="
        echo ""

    - name: Keep Alive
      run: |
        while true; do
          echo "[$(date)] Kali Linux Active..."
          sleep 300
        done
