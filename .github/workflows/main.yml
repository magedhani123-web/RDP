name: Kali Linux Docker GUI + Tailscale

on:
  workflow_dispatch:

jobs:
  kali:
    runs-on: ubuntu-latest

    steps:
      - name: Install Docker
        run: |
          sudo apt update
          sudo apt install -y docker.io
          sudo systemctl start docker

      - name: Run Kali Linux Desktop (Docker)
        run: |
          docker run -d \
            --name kali \
            -p 5901:5901 \
            -p 6080:6080 \
            kalilinux/kali-rolling \
            bash -c "
              apt update &&
              apt install -y xfce4 tightvncserver novnc websockify &&
              mkdir -p ~/.vnc &&
              echo '${{ secrets.VNC_PASS }}' | vncpasswd -f > ~/.vnc/passwd &&
              chmod 600 ~/.vnc/passwd &&
              vncserver :1 &&
              websockify --web=/usr/share/novnc/ 6080 localhost:5901
            "

      - name: Install Tailscale
        run: |
          curl -fsSL https://tailscale.com/install.sh | sh
          sudo tailscale up \
            --authkey="${{ secrets.TS_AUTH_KEY }}" \
            --hostname="Kali-Docker" \
            --accept-routes \
            --accept-dns=false

      - name: Show Access Info
        run: |
          echo "======================================"
          echo "✔ Kali Linux Desktop (Docker) is LIVE!"
          echo "✔ Tailscale IP:"
          tailscale ip -4
          echo "--------------------------------------"
          echo "VNC:   100.x.x.x:5901"
          echo "noVNC: http://100.x.x.x:6080"
          echo "Password: ${{ secrets.VNC_PASS }}"
          echo "======================================"
          sleep 999999
