name: Ubuntu Desktop + NoMachine + Tailscale

on:
  workflow_dispatch:

jobs:
  desktop:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Fix containerd conflict & install Docker
        run: |
          sudo apt-get update -y
          sudo apt-get remove -y containerd containerd.io || true
          sudo apt-get install -y ca-certificates curl gnupg lsb-release software-properties-common
          curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /usr/share/keyrings/docker.gpg
          echo "deb [arch=amd64 signed-by=/usr/share/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable" \
            | sudo tee /etc/apt/sources.list.d/docker.list
          sudo apt-get update -y
          sudo apt-get install -y docker-ce docker-ce-cli containerd.io docker-compose-plugin
          sudo systemctl enable --now docker

      - name: Pull Ubuntu base image
        run: |
          docker pull ubuntu:22.04

      - name: Run container with systemd support
        run: |
          docker rm -f ubuntu_gui || true
          docker run -d --name ubuntu_gui --privileged \
            -v /sys/fs/cgroup:/sys/fs/cgroup:ro \
            -p 4000:4000 \
            ubuntu:22.04 sleep infinity

      - name: Install Ubuntu Desktop + NoMachine inside container
        run: |
          docker exec ubuntu_gui bash -c "apt-get update"
          docker exec ubuntu_gui bash -c "DEBIAN_FRONTEND=noninteractive apt-get install -y ubuntu-desktop wget"

          # ØªØ­Ù…ÙŠÙ„ Ø£Ø­Ø¯Ø« Ø¥ØµØ¯Ø§Ø± Ø±Ø³Ù…ÙŠ Ù…Ù† NoMachine
          docker exec ubuntu_gui bash -c "wget https://download.nomachine.com/download/latest/Linux/nomachine_amd64.deb -O /tmp/nomachine.deb"

          # ØªØ«Ø¨ÙŠØª NoMachine Ø¨Ø·Ø±ÙŠÙ‚Ø© ØµØ­ÙŠØ­Ø©
          docker exec ubuntu_gui bash -c "apt install -y /tmp/nomachine.deb || dpkg -i /tmp/nomachine.deb || apt --fix-broken install -y"

      - name: Install Tailscale on host
        env:
          TS_AUTH_KEY: ${{ secrets.TS_AUTH_KEY }}
        run: |
          curl -fsSL https://tailscale.com/install.sh | sh
          sudo tailscale up --authkey="${TS_AUTH_KEY}" --hostname=GitHub-NoMachine --accept-routes --accept-dns=false
          tailscale ip -4

      - name: Print connection info
        run: |
          TS_IP=$(tailscale ip -4)
          echo "============================"
          echo "ðŸŽ‰ NoMachine Ø¬Ø§Ù‡Ø²!"
          echo "Ø§ØªØµÙ„ Ù…Ù† Ø¬Ù‡Ø§Ø²Ùƒ Ø¹Ø¨Ø± NoMachine NX:"
          echo "nx://$TS_IP"
          echo ""
          echo "Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: root"
          echo "ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±: (Ù‚Ù… Ø¨ØªØ¹ÙŠÙŠÙ†Ù‡Ø§ Ø¯Ø§Ø®Ù„ Ø§Ù„Ø¬Ù„Ø³Ø© Ø¨Ø¹Ø¯ Ø§Ù„Ø¯Ø®ÙˆÙ„)"
          echo "============================"

      - name: Keep session alive
        run: |
          while true; do sleep 300; done
