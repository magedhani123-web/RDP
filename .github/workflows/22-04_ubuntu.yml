name: Kali-NoMachine-Fixed

on:
  workflow_dispatch:

jobs:
  kali:
    runs-on: ubuntu-latest
    timeout-minutes: 3600

    steps:
    - name: Install Docker
      run: |
        sudo apt update
        docker --version

    - name: Pull & Start Kali Container
      run: |
        sudo docker pull kalilinux/kali-rolling
        sudo docker run -d --name kali \
          --hostname kali-runner \
          --cap-add=NET_ADMIN \
          --device=/dev/net/tun \
          kalilinux/kali-rolling sleep infinity

    - name: Setup GUI + NoMachine
      run: |
        sudo docker exec kali bash -c "
          apt update &&
          DEBIAN_FRONTEND=noninteractive apt install -y xfce4 xfce4-goodies dbus-x11 wget curl sudo &&
          wget https://web9001.nomachine.com/download/9.3/Linux/nomachine_9.3.7_1_amd64.deb &&
          dpkg -i nomachine_*.deb || apt --fix-broken install -y
        "

    - name: Create User
      run: |
        PASS=$(tr -dc A-Za-z0-9 </dev/urandom | head -c 16)
        sudo docker exec kali bash -c "
          useradd -m -s /bin/bash kaliuser &&
          echo 'kaliuser:$PASS' | chpasswd &&
          usermod -aG sudo kaliuser
        "
        echo "USER=kaliuser" >> $GITHUB_ENV
        echo "PASS=$PASS" >> $GITHUB_ENV

    - name: Start NoMachine & Desktop Services
      run: |
        # ØªØ´ØºÙŠÙ„ Ø§Ù„Ø®Ø¯Ù…Ø§Øª ÙŠØ¯ÙˆÙŠØ§Ù‹ Ù„ØªØ¬Ø§ÙˆØ² ØºÙŠØ§Ø¨ systemd
        sudo docker exec kali bash -c "
          mkdir -p /var/run/dbus
          dbus-daemon --system --fork
          /usr/NX/bin/nxserver --startup
        "

    - name: Install & Fix Tailscale (No systemd Mode)
      env:
        TAILSCALE_AUTH_KEY: ${{ secrets.TAILSCALE_AUTH_KEY }}
      run: |
        # ØªØ«Ø¨ÙŠØª Tailscale
        sudo docker exec kali bash -c "curl -fsSL https://tailscale.com/install.sh | sh"
        
        # Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø¬Ù„Ø¯Ø§Øª Ø§Ù„Ø¶Ø±ÙˆØ±ÙŠØ©
        sudo docker exec kali mkdir -p /var/run/tailscale /var/lib/tailscale
        
        # ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…Ø­Ø±Ùƒ ÙŠØ¯ÙˆÙŠØ§Ù‹ ÙÙŠ Ø§Ù„Ø®Ù„ÙÙŠØ© (Userspace Networking)
        sudo docker exec -d kali bash -c "tailscaled --tun=userspace-networking --state=/var/lib/tailscale/tailscaled.state"
        
        # Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± Ù„Ù„ØªØ£ÙƒØ¯ Ù…Ù† ØªØ´ØºÙŠÙ„ Ø§Ù„Ø®Ø¯Ù…Ø©
        sleep 5
        
        # Ø±Ø¨Ø· Ø§Ù„Ø¬Ù‡Ø§Ø² Ø¨Ø§Ù„Ø´Ø¨ÙƒØ©
        sudo docker exec kali tailscale up --authkey=${TAILSCALE_AUTH_KEY} --hostname=kali-gh
        
        # Ø¬Ù„Ø¨ Ø§Ù„Ù€ IP
        TSIP=$(sudo docker exec kali tailscale ip -4)
        echo "TSIP=$TSIP" >> $GITHUB_ENV

    - name: Display Connection Credentials
      run: |
        echo "------------------------------------------"
        echo "âœ… Kali Linux is Ready!"
        echo "ğŸŒ Tailscale IP: ${{ env.TSIP }}"
        echo "ğŸ‘¤ Username:     ${{ env.USER }}"
        echo "ğŸ”‘ Password:     ${{ env.PASS }}"
        echo "ğŸ–¥ï¸ Protocol:     NoMachine (NX)"
        echo "ğŸšª Port:         4000"
        echo "------------------------------------------"

    - name: Keep Alive Loop
      run: |
        echo "Server is running... You can connect now."
        # Ø³ÙŠØ¨Ù‚Ù‰ Ø§Ù„Ø³ÙŠØ±ÙØ± ÙŠØ¹Ù…Ù„ Ù„Ù…Ø¯Ø© 6 Ø³Ø§Ø¹Ø§Øª Ø£Ùˆ Ø­ØªÙ‰ ØªÙ‚ÙˆÙ… Ø¨Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ù…Ù‡Ù…Ø©
        for i in {1..72}; do
          echo "[$(date)] Keep-alive: Kali GUI is active..."
          sleep 300
        done
