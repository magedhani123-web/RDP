name: Kali-NoMachine

on:
  workflow_dispatch:

jobs:
  kali:
    runs-on: ubuntu-latest
    timeout-minutes: 3600

    steps:
    - name: Install Docker
      run: |
        sudo apt update
        docker --version
        sudo docker info

    - name: Pull Kali Image
      run: |
        sudo docker pull kalilinux/kali-rolling

    - name: Start Kali Container
      run: |
        sudo docker run -d --name kali \
          --hostname kali-runner \
          --cap-add=NET_ADMIN \
          --device=/dev/net/tun \
          kalilinux/kali-rolling sleep infinity

    - name: Setup GUI + NoMachine
      run: |
        sudo docker exec kali bash -c "
          apt update &&
          apt install -y xfce4 xfce4-goodies dbus-x11 wget curl sudo &&
          wget https://web9001.nomachine.com/download/9.3/Linux/nomachine_9.3.7_1_amd64.deb &&
          dpkg -i nomachine_*.deb || apt --fix-broken install -y
        "

    - name: Create User
      run: |
        PASS=$(tr -dc A-Za-z0-9 </dev/urandom | head -c 16)
        sudo docker exec kali bash -c "
          useradd -m -s /bin/bash kaliuser &&
          echo 'kaliuser:$PASS' | chpasswd &&
          usermod -aG sudo kaliuser
        "
        echo "USER=kaliuser" >> $GITHUB_ENV
        echo "PASS=$PASS" >> $GITHUB_ENV

    - name: Start NoMachine
      run: |
        sudo docker exec kali /usr/NX/bin/nxserver --start
        sudo docker exec kali /usr/NX/bin/nxserver --status

    - name: Install Tailscale
      run: |
        sudo docker exec kali bash -c "
          curl -fsSL https://tailscale.com/install.sh | sh
        "

    - name: Start Tailscale (Docker way)
      env:
        TAILSCALE_AUTH_KEY: ${{ secrets.TAILSCALE_AUTH_KEY }}
      run: |
        sudo docker exec kali bash -c "
          tailscaled --tun=userspace-networking &
          sleep 5
          tailscale up --authkey=${TAILSCALE_AUTH_KEY} --hostname=kali-gh
          tailscale ip -4
        " | tee ts.log

        TSIP=$(grep -Eo '([0-9]{1,3}\.){3}[0-9]{1,3}' ts.log | tail -1)
        echo "TSIP=$TSIP" >> $GITHUB_ENV

    - name: Show Connection Info
      run: |
        echo ""
        echo "========== Kali NoMachine =========="
        echo "IP:       $TSIP"
        echo "User:     $USER"
        echo "Password: $PASS"
        echo "Port:     4000"
        echo "Protocol: NX"
        echo "==================================="
        echo ""

    - name: Keep Alive
      run: |
        while true; do
          echo "[$(date)] Kali GUI Active"
          sleep 300
        done
