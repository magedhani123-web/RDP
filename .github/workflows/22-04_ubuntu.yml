name: Kali-NoMachine

on:
  workflow_dispatch:

jobs:
  kali:
    runs-on: ubuntu-latest
    timeout-minutes: 3600

    steps:
    - name: Install Docker
      run: |
        sudo apt update
        docker --version

    - name: Pull Kali Image
      run: |
        sudo docker pull kalilinux/kali-rolling

    - name: Start Kali Container
      run: |
        sudo docker run -d --name kali \
          --hostname kali-runner \
          --cap-add=NET_ADMIN \
          --device=/dev/net/tun \
          kalilinux/kali-rolling sleep infinity

    - name: Setup GUI + NoMachine
      run: |
        sudo docker exec kali bash -c "
          apt update &&
          DEBIAN_FRONTEND=noninteractive apt install -y xfce4 xfce4-goodies dbus-x11 wget curl sudo &&
          wget https://web9001.nomachine.com/download/9.3/Linux/nomachine_9.3.7_1_amd64.deb &&
          dpkg -i nomachine_*.deb || apt --fix-broken install -y
        "

    - name: Create User
      run: |
        PASS=$(tr -dc A-Za-z0-9 </dev/urandom | head -c 16)
        sudo docker exec kali bash -c "
          useradd -m -s /bin/bash kaliuser &&
          echo 'kaliuser:$PASS' | chpasswd &&
          usermod -aG sudo kaliuser
        "
        echo "USER=kaliuser" >> $GITHUB_ENV
        echo "PASS=$PASS" >> $GITHUB_ENV

    - name: Start NoMachine & DBUS
      run: |
        sudo docker exec kali bash -c "service dbus start && /usr/NX/bin/nxserver --start"
        sudo docker exec kali /usr/NX/bin/nxserver --status

    - name: Install Tailscale
      run: |
        sudo docker exec kali bash -c "curl -fsSL https://tailscale.com/install.sh | sh"

    - name: Start Tailscale (Userspace Mode)
      env:
        TAILSCALE_AUTH_KEY: ${{ secrets.TAILSCALE_AUTH_KEY }}
      run: |
        # تشغيل tailscaled في الخلفية داخل الحاوية
        sudo docker exec -d kali bash -c "tailscaled --tun=userspace-networking --state=/tmp/tailscale.state"
        sleep 5
        # تسجيل الدخول
        sudo docker exec kali tailscale up --authkey=${TAILSCALE_AUTH_KEY} --hostname=kali-gh
        # جلب عنوان IP
        TSIP=$(sudo docker exec kali tailscale ip -4)
        echo "TSIP=$TSIP" >> $GITHUB_ENV

    - name: Connection Information
      run: |
        echo "------------------------------------------"
        echo "Kali Linux is ready!"
        echo "IP Address: ${{ env.TSIP }}"
        echo "Username:   ${{ env.USER }}"
        echo "Password:   ${{ env.PASS }}"
        echo "NoMachine Port: 4000"
        echo "------------------------------------------"

    - name: Keep Alive (Wait for 6 hours)
      run: |
        # سيبقى السيرفر يعمل حتى تنهي المهمة يدوياً أو تنتهي المدة
        for i in {1..72}; do
          echo "[$(date)] Serevr is running... (Step $i/72)"
          sleep 300
        done
